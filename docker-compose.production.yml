# =============================================================================
# PALAUTESEINÄ (FEEDBACK WALL) - PRODUCTION DOCKER COMPOSE
# =============================================================================
# Käyttö: Coolify Docker Compose -projekti
# 
# Coolify Magic Environment Variables:
#   - SERVICE_FQDN_APP: Coolify generoi FQDN automaattisesti
#   - SERVICE_PASSWORD_<NAME>: Coolify generoi salasanat automaattisesti
#   - SERVICE_USER_<NAME>: Coolify generoi käyttäjänimet automaattisesti
#
# ServersideUp PHP Image: serversideup/php:8.4-fpm-nginx
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # APP - Laravel + Nginx (PHP-FPM)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        PHP_VERSION: "8.4"
    image: ${REGISTRY:-}feedbackwall:${IMAGE_TAG:-latest}
    container_name: feedbackwall-app
    restart: unless-stopped
    
    # Coolify proxy kuuntelee tätä porttia
    expose:
      - "8080"
    
    environment:
      # Coolify FQDN - tämä triggeröi Coolify proxyn
      SERVICE_FQDN_APP_8080: /
      
      # ServersideUp spesifiset
      SSL_MODE: "off"                    # Coolify hoitaa SSL:n
      PHP_OPCACHE_ENABLE: "1"
      PHP_MEMORY_LIMIT: "256M"
      PHP_MAX_EXECUTION_TIME: "30"
      PHP_POST_MAX_SIZE: "64M"
      PHP_UPLOAD_MAX_FILESIZE: "64M"
      
      # Laravel ympäristömuuttujat
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      # Coolify generoi URL:n SERVICE_FQDN_APP:sta (jaetaan kaikkien containerien kesken)
      APP_URL: ${SERVICE_FQDN_APP}
      # APP_KEY pitää asettaa manuaalisesti Coolify UI:ssa
      APP_KEY: ${APP_KEY}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      # Database - käytä Coolifyn generoituja arvoja
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: $SERVICE_USER_POSTGRES
      DB_PASSWORD: $SERVICE_PASSWORD_POSTGRES
      
      # Cache, Session, Queue
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      # Redis - käytä Coolifyn generoitua salasanaa
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: $SERVICE_PASSWORD_REDIS
      
      # Mail (konfiguroi Coolify UI:ssa)
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Palauteseinä}
      
      # Google OAuth (konfiguroi Coolify UI:ssa)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${SERVICE_FQDN_APP}/auth/google/callback
      
      # Admin & Moderation
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      MODERATION_SERVICE_URL: ${MODERATION_SERVICE_URL:-}
      
      TELESCOPE_ENABLED: ${TELESCOPE_ENABLED:-true}
      
      # Deployment flag
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-false}
    
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    
    networks:
      - feedbackwall-internal
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      - "coolify.managed=true"
  
  # ---------------------------------------------------------------------------
  # QUEUE WORKER
  # ---------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        PHP_VERSION: "8.4"
    image: ${REGISTRY:-}feedbackwall:${IMAGE_TAG:-latest}
    container_name: feedbackwall-queue
    restart: unless-stopped
    
    command: ["php", "artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600", "--memory=128"]
    
    environment:
      CONTAINER_ROLE: queue
      
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      # Sama URL kuin app-containerilla
      APP_URL: ${SERVICE_FQDN_APP}
      APP_KEY: ${APP_KEY}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: $SERVICE_USER_POSTGRES
      DB_PASSWORD: $SERVICE_PASSWORD_POSTGRES
      
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: $SERVICE_PASSWORD_REDIS
      
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Palauteseinä}
      
      MODERATION_SERVICE_URL: ${MODERATION_SERVICE_URL:-}
    
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    
    networks:
      - feedbackwall-internal
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "php", "artisan", "queue:monitor", "default", "--max=100"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
  
  # ---------------------------------------------------------------------------
  # SCHEDULER (Cron)
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        PHP_VERSION: "8.4"
    image: ${REGISTRY:-}feedbackwall:${IMAGE_TAG:-latest}
    container_name: feedbackwall-scheduler
    restart: unless-stopped
    
    command: ["php", "artisan", "schedule:work"]
    
    environment:
      CONTAINER_ROLE: scheduler
      
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      # Sama URL kuin app-containerilla
      APP_URL: ${SERVICE_FQDN_APP}
      APP_KEY: ${APP_KEY}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      DB_CONNECTION: pgsql
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: $SERVICE_USER_POSTGRES
      DB_PASSWORD: $SERVICE_PASSWORD_POSTGRES
      
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: $SERVICE_PASSWORD_REDIS
    
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    
    networks:
      - feedbackwall-internal
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
  
  # ---------------------------------------------------------------------------
  # POSTGRES (Database)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: feedbackwall-postgres
    restart: unless-stopped
    
    environment:
      # Coolify generoi käyttäjän ja salasanan automaattisesti
      POSTGRES_DB: ${DB_DATABASE:-feedbackwall}
      POSTGRES_USER: $SERVICE_USER_POSTGRES
      POSTGRES_PASSWORD: $SERVICE_PASSWORD_POSTGRES
      PGDATA: /var/lib/postgresql/data/pgdata
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
    
    networks:
      - feedbackwall-internal
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  # ---------------------------------------------------------------------------
  # REDIS (Cache, Session, Queue)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: feedbackwall-redis
    restart: unless-stopped
    
    # Coolify generoi REDIS salasanan automaattisesti
    command: >
      redis-server
      --appendonly yes
      --requirepass $SERVICE_PASSWORD_REDIS
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    
    volumes:
      - redis-data:/data
    
    networks:
      - feedbackwall-internal
    
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$SERVICE_PASSWORD_REDIS", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  feedbackwall-internal:
    driver: bridge
    internal: true

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  app-storage:
    driver: local
  app-logs:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local

# =============================================================================
# COOLIFY MAGIC VARIABLES - DOKUMENTAATIO
# =============================================================================
# Coolify generoi automaattisesti:
#   - SERVICE_FQDN_APP: https://your-domain.com (asetetaan Coolify UI:ssa)
#   - SERVICE_USER_POSTGRES: Satunnainen käyttäjänimi PostgreSQL:lle
#   - SERVICE_PASSWORD_POSTGRES: Satunnainen salasana PostgreSQL:lle
#   - SERVICE_PASSWORD_REDIS: Satunnainen salasana Redisille
#
# Sinun täytyy asettaa manuaalisesti Coolify UI:ssa:
#   - APP_KEY: Laravel encryption key (php artisan key:generate --show)
#   - GOOGLE_CLIENT_ID: Google OAuth client ID
#   - GOOGLE_CLIENT_SECRET: Google OAuth client secret
#   - ADMIN_EMAILS: Pilkuilla erotettu lista admin-sähköposteista
#   - MAIL_*: Sähköpostiasetukset (valinnainen)
#
# Ensimmäinen deploy:
#   1. Aseta APP_KEY Coolify UI:ssa
#   2. Aseta RUN_MIGRATIONS=true
#   3. Deploy
#   4. Aseta RUN_MIGRATIONS=false
