# =============================================================================
# PALAUTESEINÄ (FEEDBACK WALL) - PRODUCTION DOCKER COMPOSE
# =============================================================================
# Käyttö: Coolify Docker Compose -projekti
#
# Coolify Magic Environment Variables:
#   - SERVICE_URL_APP: Coolify generoi HTTPS URL automaattisesti
#   - SERVICE_PASSWORD_<NAME>: Coolify generoi salasanat automaattisesti
#   - SERVICE_USER_<NAME>: Coolify generoi käyttäjänimet automaattisesti
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # APP - Laravel + Nginx (PHP-FPM)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile.production
    environment:
      # Laravel ympäristömuuttujat
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: production
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${SERVICE_URL_APP}
      APP_KEY: ${APP_KEY}
      APP_TIMEZONE: ${APP_TIMEZONE:-Europe/Helsinki}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      # Database - Coolify generoi käyttäjän ja salasanan
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: ${SERVICE_USER_POSTGRES}
      DB_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      
      # Cache, Session, Queue
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${SERVICE_PASSWORD_REDIS}
      
      # Mail (konfiguroi Coolify UI:ssa)
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Palauteseinä}
      
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${SERVICE_URL_APP}/auth/google/callback
      
      # Admin & Moderation
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      MODERATION_SERVICE_URL: ${MODERATION_SERVICE_URL:-}
      
      # Telescope
      TELESCOPE_ENABLED: ${TELESCOPE_ENABLED:-false}
      
      # ServersideUp Laravel Automations
      AUTORUN_ENABLED: true
      AUTORUN_LARAVEL_MIGRATION: ${RUN_MIGRATIONS:-false}
      AUTORUN_LARAVEL_MIGRATION_TIMEOUT: 60
      AUTORUN_LARAVEL_STORAGE_LINK: true
      AUTORUN_LARAVEL_CONFIG_CACHE: true
      AUTORUN_LARAVEL_ROUTE_CACHE: true
      AUTORUN_LARAVEL_VIEW_CACHE: true
      AUTORUN_LARAVEL_EVENT_CACHE: true
      
      # PHP Optimizations
      SSL_MODE: "off"
      PHP_OPCACHE_ENABLE: 1
      PHP_MEMORY_LIMIT: 256M
      PHP_UPLOAD_MAX_FILE_SIZE: 64M
      PHP_POST_MAX_SIZE: 64M
      PHP_MAX_EXECUTION_TIME: 30
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # QUEUE WORKER
  # ---------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: Dockerfile.production
    command: ["php", "/var/www/html/artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600", "--memory=128"]
    stop_signal: SIGTERM
    environment:
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: production
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${SERVICE_URL_APP}
      APP_KEY: ${APP_KEY}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: ${SERVICE_USER_POSTGRES}
      DB_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${SERVICE_PASSWORD_REDIS}
      
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Palauteseinä}
      
      MODERATION_SERVICE_URL: ${MODERATION_SERVICE_URL:-}
      
      # Disable automations for queue worker
      AUTORUN_ENABLED: false
      
      PHP_OPCACHE_ENABLE: 1
      PHP_MEMORY_LIMIT: 128M
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # SCHEDULER (Cron)
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.production
    command: ["php", "/var/www/html/artisan", "schedule:work"]
    stop_signal: SIGTERM
    environment:
      APP_NAME: ${APP_NAME:-Palauteseinä}
      APP_ENV: production
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${SERVICE_URL_APP}
      APP_KEY: ${APP_KEY}
      
      LOG_CHANNEL: ${LOG_CHANNEL:-stderr}
      LOG_LEVEL: ${LOG_LEVEL:-warning}
      
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-feedbackwall}
      DB_USERNAME: ${SERVICE_USER_POSTGRES}
      DB_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      
      CACHE_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${SERVICE_PASSWORD_REDIS}
      
      # Disable automations for scheduler
      AUTORUN_ENABLED: false
      
      PHP_OPCACHE_ENABLE: 1
      PHP_MEMORY_LIMIT: 128M
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # POSTGRES (Database)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${DB_DATABASE:-feedbackwall}
      POSTGRES_USER: ${SERVICE_USER_POSTGRES}
      POSTGRES_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # REDIS (Cache, Session, Queue)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --requirepass ${SERVICE_PASSWORD_REDIS}
      --appendonly yes
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

volumes:
  app-storage:
  app-logs:
  postgres-data:
  redis-data:
